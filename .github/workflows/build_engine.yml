name: 1. Build Engine (Manual)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-engine:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: ðŸ Python Embeddable laden
      shell: cmd
      run: |
        curl -L -o python.zip https://www.python.org/ftp/python/3.10.11/python-3.10.11-embed-amd64.zip
        mkdir Engine
        tar -xf python.zip -C Engine
        del python.zip

    # --- NEU: TKINTER FIX START ---
    - name: ðŸ–¼ï¸ Tkinter Support nachinstallieren
      shell: cmd
      run: |
        echo Lade Tkinter Dateien...
        REM Wir holen die TCL/TK DLLs aus dem offiziellen Nuget Paket oder einer sauberen Quelle
        REM Da das kompliziert ist, nutzen wir einen Trick: Wir laden das 'normale' Python zip (nicht embed)
        REM aber nur die DLLs. Da das zu groÃŸ ist, nutzen wir hier einen direkten Download-Trick.
        
        REM Schritt 1: tkinter-Library files
        curl -L -o tcltk.zip "https://github.com/dongyuwei/h_python_tkinter/archive/refs/heads/main.zip"
        tar -xf tcltk.zip
        
        echo Kopiere Tkinter Dateien in die Engine...
        REM DLLs kopieren
        copy "h_python_tkinter-main\*.dll" "Engine\"
        REM Lib Ordner kopieren
        xcopy /E /I /Y "h_python_tkinter-main\tcl" "Engine\tcl"
        xcopy /E /I /Y "h_python_tkinter-main\tkinter" "Engine\Lib\tkinter"
        
        REM Clean up
        rmdir /s /q h_python_tkinter-main
        del tcltk.zip
    # --- NEU: TKINTER FIX ENDE ---

    - name: ðŸ”§ Pip installieren
      working-directory: Engine
      shell: cmd
      run: |
        curl -L -o get-pip.py https://bootstrap.pypa.io/get-pip.py
        .\python.exe get-pip.py --no-warn-script-location
        
        REM Wichtig: Wir muessen den Pfad fuer Tkinter in die .pth Datei schreiben
        echo import site>> python310._pth
        del get-pip.py

    - name: ðŸ“¦ Schwere Bibliotheken installieren
      working-directory: Engine
      shell: cmd
      run: |
        echo Installiere PyTorch (GPU)...
        .\python.exe -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
        
        echo Installiere Requirements...
        .\python.exe -m pip install numpy==1.26.4
        .\python.exe -m pip install TTS easyocr pyaudio keyboard pyautogui opencv-python pillow soundfile

        echo Bereinige Cache...
        .\python.exe -m pip cache purge
        if exist "Lib\site-packages\torch\test" rmdir /s /q "Lib\site-packages\torch\test"

    - name: ðŸ¤ Engine Zippen und Splitten (7-Zip)
      shell: cmd
      run: |
        7z a -tzip -v1900m LQAG_Engine_v1.zip Engine

    - name: ðŸš€ Release erstellen und Upload
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Engine-v1.1
        name: "LQAG Engine Base v1.1 (Mit Tkinter Fix)"
        body: |
          ### WICHTIG:
          1. Lade **beide** Dateien herunter (`.001` und `.002`).
          2. Rechtsklick auf `.001` -> 7-Zip -> Hier entpacken.
        draft: false
        prerelease: false
        files: LQAG_Engine_v1.zip.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
