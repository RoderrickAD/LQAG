name: Build Engine (V9 - Fixed TTS Build)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-engine:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # 1. MSVC Compiler Setup
    - name: üõ†Ô∏è Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    # 2. System Python (Donor)
    - name: üêç Setup System Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.11' 
        architecture: 'x64'

    # 3. Download Portable Python
    - name: üêç Download Portable Python
      shell: cmd
      run: |
        curl -L -o python.zip https://www.python.org/ftp/python/3.10.11/python-3.10.11-embed-amd64.zip
        mkdir Engine
        tar -xf python.zip -C Engine
        del python.zip

    # 4. Tkinter Transplant
    - name: üè• Tkinter Transplantieren
      shell: powershell
      run: |
        $DonorPath = python -c "import sys; print(sys.prefix)"
        $Dest = "$pwd\Engine"
        
        New-Item -ItemType Directory -Force -Path "$Dest\Lib"
        New-Item -ItemType Directory -Force -Path "$Dest\DLLs"

        copy "$DonorPath\DLLs\_tkinter.pyd" "$Dest\DLLs\"
        copy "$DonorPath\DLLs\tcl86t.dll" "$Dest\"
        copy "$DonorPath\DLLs\tk86t.dll" "$Dest\"
        
        Copy-Item -Path "$DonorPath\Lib\tkinter" -Destination "$Dest\Lib\tkinter" -Recurse -Force
        Copy-Item -Path "$DonorPath\tcl" -Destination "$Dest\tcl" -Recurse -Force

    # 5. Config Patch
    - name: üîß Config Patch
      working-directory: Engine
      shell: cmd
      run: |
        echo python310.zip> python310._pth
        echo .>> python310._pth
        echo Lib>> python310._pth
        echo DLLs>> python310._pth
        echo Lib\site-packages>> python310._pth
        echo import site>> python310._pth

    # 6. Pip Setup
    - name: üîß Pip Setup
      working-directory: Engine
      shell: cmd
      run: |
        curl -L -o get-pip.py https://bootstrap.pypa.io/get-pip.py
        .\python.exe get-pip.py --no-warn-script-location
        del get-pip.py
        .\python.exe -m pip install --upgrade pip setuptools wheel

    # 7. CRITICAL FIX: Install Build Tools First
    - name: üî® Install Build Dependencies
      working-directory: Engine
      shell: cmd
      run: |
        echo Installing build tools...
        .\python.exe -m pip install "numpy<1.24" cython "setuptools<70" "wheel<0.43"
        .\python.exe -m pip install "packaging>=20.0" "mecab-python3>=1.0.0"

    # 8. Install Core Dependencies (Pre-built wheels)
    - name: üß± Install Core Dependencies
      working-directory: Engine
      shell: cmd
      run: |
        echo Installing core packages...
        .\python.exe -m pip install scipy pandas librosa matplotlib pysbd tqdm
        .\python.exe -m pip install coqpit trainer inflect
        .\python.exe -m pip install gruut[de,en] phonemizer
        
        echo Installing PyTorch...
        .\python.exe -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 --no-warn-script-location

    # 9. FIX: Install TTS dependencies manually first
    - name: üì¶ Pre-install TTS Dependencies
      working-directory: Engine
      shell: cmd
      run: |
        echo Installing TTS dependencies separately...
        .\python.exe -m pip install "jieba" "pypinyin" "anyascii" "unidecode"
        .\python.exe -m pip install "numba" "llvmlite" 
        .\python.exe -m pip install "umap-learn" "pysbd"

    # 10. TTS INSTALLATION - Using specific stable version
    - name: üó£Ô∏è Install TTS
      working-directory: Engine
      shell: cmd
      run: |
        echo Installing TTS...
        REM Try PyPI version first (more stable for Windows builds)
        .\python.exe -m pip install TTS==0.22.0 --no-warn-script-location || (
          echo PyPI failed, trying Git...
          .\python.exe -m pip install git+https://github.com/coqui-ai/TTS.git@v0.22.0 --no-build-isolation --no-warn-script-location
        )

    # 11. Additional Tools
    - name: üì¶ Install Additional Tools
      working-directory: Engine
      shell: cmd
      run: |
        echo Installing helper tools...
        .\python.exe -m pip install "opencv-python-headless<4.10" "opencv-python<4.10"
        .\python.exe -m pip install easyocr keyboard pyautogui pillow soundfile --no-warn-script-location

    # 12. Quality Check
    - name: üîç Test Imports
      working-directory: Engine
      shell: cmd
      run: |
        echo --- TEST KEYBOARD ---
        .\python.exe -c "import keyboard; print('‚úì Keyboard OK')" || exit 1
        
        echo --- TEST TTS ---
        .\python.exe -c "import TTS; print('‚úì TTS OK'); print(TTS.__version__)" || exit 1
        
        echo --- TEST TORCH ---
        .\python.exe -c "import torch; print('‚úì Torch OK'); print(torch.__version__)" || exit 1

    # 13. Cleanup & Zip
    - name: üßπ Cleanup and Package
      working-directory: Engine
      shell: cmd
      run: |
        .\python.exe -m pip cache purge
        if exist "Lib\site-packages\torch\test" rmdir /s /q "Lib\site-packages\torch\test"
        if exist "Lib\site-packages\TTS\tests" rmdir /s /q "Lib\site-packages\TTS\tests"
        
        cd ..
        7z a -tzip -v1900m LQAG_Engine_V9.zip Engine

    - name: üöÄ Release Upload
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Engine-V9-Fixed
        name: "LQAG Engine V9 (Fixed Build)"
        body: |
          ### Engine V9 - Fixed TTS Build
          
          **Changes:**
          - Fixed TTS compilation issues
          - Added missing build dependencies
          - Using stable TTS 0.22.0
          - Pre-installed all dependencies to avoid build conflicts
          
          **Components:**
          - Python 3.10.11 (Portable)
          - TTS 0.22.0 with Coqui XTTS
          - PyTorch with CUDA 12.1
          - All dependencies pre-compiled
        draft: false
        prerelease: false
        files: LQAG_Engine_V9.zip.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
