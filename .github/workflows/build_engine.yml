name: 1. Build Engine (Manual)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-engine:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    # 1. Full Python als Spender laden
    - name: ðŸ Setup Full Python (Source)
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.11' 
        architecture: 'x64'

    # 2. Embeddable Python laden
    - name: ðŸ Download Embeddable Python (Target)
      shell: cmd
      run: |
        curl -L -o python.zip https://www.python.org/ftp/python/3.10.11/python-3.10.11-embed-amd64.zip
        mkdir Engine
        tar -xf python.zip -C Engine
        del python.zip

    # 3. TRANSPLANTATION (Tkinter + DLLs)
    - name: ðŸ¥ Tkinter & DLLs transplantieren
      shell: powershell
      run: |
        $source = (python -c "import sys; print(sys.prefix)")
        $dest = "Engine"
        echo "Source: $source"
        
        # Ordner erstellen
        New-Item -ItemType Directory -Force -Path "$dest\Lib"
        New-Item -ItemType Directory -Force -Path "$dest\DLLs"

        # A. Wichtige DLLs kopieren (in Root und DLLs zur Sicherheit)
        copy "$source\DLLs\_tkinter.pyd" "$dest\DLLs\"
        copy "$source\DLLs\tcl86t.dll" "$dest\"
        copy "$source\DLLs\tk86t.dll" "$dest\"
        
        # B. Tkinter Python Code kopieren
        Copy-Item -Path "$source\Lib\tkinter" -Destination "$dest\Lib\tkinter" -Recurse -Force

        # C. Tcl Grafiken kopieren
        Copy-Item -Path "$source\tcl" -Destination "$dest\tcl" -Recurse -Force
        
        echo "Dateien kopiert."

    # 4. KONFIGURATION REPARIEREN (Das hat gefehlt!)
    - name: ðŸ”§ Pfade konfigurieren (.pth Datei)
      working-directory: Engine
      shell: cmd
      run: |
        REM Wir lÃ¶schen die alte Datei und schreiben eine neue.
        REM Damit sagen wir Python EXAKT, wo es suchen soll.
        
        echo python310.zip> python310._pth
        echo .>> python310._pth
        
        REM Hier sagen wir: "Schau in den Lib Ordner!" (Da ist tkinter)
        echo Lib>> python310._pth
        
        REM Hier sagen wir: "Schau in DLLs!" (Da ist _tkinter.pyd)
        echo DLLs>> python310._pth
        
        REM Hier sagen wir: "Schau in site-packages!" (Da kommen pip Sachen hin)
        echo Lib\site-packages>> python310._pth
        
        REM Und pip aktivieren
        echo import site>> python310._pth
        
        type python310._pth

    # 5. Pip und Pakete
    - name: ðŸ”§ Pip und Pakete installieren
      working-directory: Engine
      shell: cmd
      run: |
        curl -L -o get-pip.py https://bootstrap.pypa.io/get-pip.py
        .\python.exe get-pip.py --no-warn-script-location
        del get-pip.py

    - name: ðŸ“¦ Schwere Pakete installieren
      working-directory: Engine
      shell: cmd
      run: |
        echo Installiere PyTorch...
        .\python.exe -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
        
        echo Installiere Requirements...
        .\python.exe -m pip install numpy==1.26.4
        .\python.exe -m pip install TTS easyocr pyaudio keyboard pyautogui opencv-python pillow soundfile

        echo Bereinige Cache...
        .\python.exe -m pip cache purge
        if exist "Lib\site-packages\torch\test" rmdir /s /q "Lib\site-packages\torch\test"

    - name: ðŸ¤ Engine Zippen (Split)
      shell: cmd
      run: |
        7z a -tzip -v1900m LQAG_Engine_v1.zip Engine

    - name: ðŸš€ Release erstellen
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Engine-v1.3
        name: "LQAG Engine Base v1.3 (Path Fix)"
        body: |
          ### WICHTIG:
          1. Lade **beide** Dateien (`.001` und `.002`).
          2. Rechtsklick auf `.001` -> 7-Zip -> Hier entpacken.
        draft: false
        prerelease: false
        files: LQAG_Engine_v1.zip.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
