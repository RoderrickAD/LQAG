name: Build Engine (Official Installer)

on:
  workflow_dispatch:

jobs:
  build-engine:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # 1. Der offizielle Installer (Silent Mode)
    # Das ist der Game-Changer: Wir installieren das ECHTE Python inkl. Tkinter
    - name: üêç Python Silent Install
      shell: powershell
      run: |
        Write-Host "Lade offiziellen Installer..."
        $url = "https://www.python.org/ftp/python/3.10.11/python-3.10.11-amd64.exe"
        Invoke-WebRequest -Uri $url -OutFile python_installer.exe
        
        # Absoluten Pfad f√ºr die Engine ermitteln
        $EnginePath = "$pwd\Engine"
        Write-Host "Installiere nach: $EnginePath"
        
        # Installer starten mit magischen Parametern (/quiet = unsichtbar, Include_tcltk=1 = WICHTIG)
        Start-Process -FilePath ".\python_installer.exe" -ArgumentList "/quiet InstallAllUsers=1 TargetDir=$EnginePath Include_doc=0 Include_tcltk=1 Include_test=0 Include_pip=1 PrependPath=0" -Wait
        
        # Aufr√§umen
        Remove-Item python_installer.exe
        
        # Pr√ºfung
        Write-Host "Pr√ºfe Installation..."
        if (Test-Path "Engine\python.exe") { Write-Host "[OK] Python.exe da." -ForegroundColor Green }
        else { Write-Host "[FEHLER] Python.exe fehlt!" -ForegroundColor Red; exit 1 }
        
        if (Test-Path "Engine\Lib\tkinter") { Write-Host "[OK] Tkinter Ordner da." -ForegroundColor Green }
        else { Write-Host "[FEHLER] Tkinter fehlt immer noch!" -ForegroundColor Red; exit 1 }
        
        if (Test-Path "Engine\tcl\tk8.6") { Write-Host "[OK] Tcl/Tk Grafiken da." -ForegroundColor Green }
        else { 
            # Manchmal liegt tcl woanders, wir suchen kurz...
            $tcl = Get-ChildItem -Path "Engine" -Filter "tcl*" -Recurse
            if ($tcl) { Write-Host "[OK] Tcl gefunden bei: $($tcl.FullName)" -ForegroundColor Green }
            else { Write-Host "[WARNUNG] Tcl Ordner seltsam, aber wir machen weiter." -ForegroundColor Yellow }
        }

    # 2. Pip Upgrade (Sicherheitshalber)
    - name: üîß Pip Upgrade
      working-directory: Engine
      shell: cmd
      run: |
        .\python.exe -m pip install --upgrade pip setuptools wheel

    # 3. KI Pakete installieren
    - name: üì¶ KI & Treiber installieren
      working-directory: Engine
      shell: cmd
      run: |
        echo --- INSTALLIERE PYTORCH ---
        .\python.exe -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 --no-warn-script-location

        echo --- INSTALLIERE REST ---
        .\python.exe -m pip install numpy==1.26.4 --no-warn-script-location
        
        REM Da der Server Visual Studio hat, k√∂nnen wir hier TTS bauen lassen falls kein Wheel da ist
        .\python.exe -m pip install TTS easyocr pyaudio keyboard pyautogui opencv-python pillow soundfile --prefer-binary --no-warn-script-location

        echo --- BEREINIGEN ---
        .\python.exe -m pip cache purge
        if exist "Lib\site-packages\torch\test" rmdir /s /q "Lib\site-packages\torch\test"
        if exist "Lib\site-packages\TTS\bin" rmdir /s /q "Lib\site-packages\TTS\bin"

    # 4. Zippen und Uploaden
    - name: ü§ê Engine Zippen
      run: |
        7z a -tzip -v1900m LQAG_Engine_Final.zip Engine

    - name: üöÄ Release erstellen
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Engine-Final-v2
        name: "LQAG Engine (Official Installer Build)"
        body: |
          ### Engine V2
          Gebaut mit dem offiziellen Python Installer (Silent Mode).
          
          **Status:**
          - Python 3.10: ‚úî
          - Tkinter: ‚úî
          - PyTorch: ‚úî
          - TTS: ‚úî
          
          **Installation:**
          Entpacken und den `Engine` Ordner nutzen.
        draft: false
        prerelease: false
        files: LQAG_Engine_Final.zip.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
