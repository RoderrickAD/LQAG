name: Build Engine (V11 - Header Fix Clean)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-engine:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # 1. MSVC Compiler (Wichtig!)
    - name: ðŸ› ï¸ Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    # 2. System Python (Der Spender fÃ¼r die Header)
    - name: ðŸ Setup System Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.11' 
        architecture: 'x64'

    # 3. Portable Python laden (Der Patient)
    - name: ðŸ Download Portable Python
      shell: cmd
      run: |
        curl -L -o python.zip https://www.python.org/ftp/python/3.10.11/python-3.10.11-embed-amd64.zip
        mkdir Engine
        tar -xf python.zip -C Engine
        del python.zip

    # 4. DIE OP: Header & Libs transplantieren (Ohne Emojis!)
    - name: ðŸ§  Header & Libs Transplantieren
      shell: powershell
      run: |
        # Wir suchen das System-Python
        $DonorPath = python -c "import sys; print(sys.prefix)"
        Write-Host "Spender-Python gefunden bei: $DonorPath"
        
        $Dest = "$pwd\Engine"
        
        # 1. Tkinter (wie immer)
        New-Item -ItemType Directory -Force -Path "$Dest\Lib"
        New-Item -ItemType Directory -Force -Path "$Dest\DLLs"
        copy "$DonorPath\DLLs\_tkinter.pyd" "$Dest\DLLs\"
        copy "$DonorPath\DLLs\tcl86t.dll" "$Dest\"
        copy "$DonorPath\DLLs\tk86t.dll" "$Dest\"
        Copy-Item -Path "$DonorPath\Lib\tkinter" -Destination "$Dest\Lib\tkinter" -Recurse -Force
        Copy-Item -Path "$DonorPath\tcl" -Destination "$Dest\tcl" -Recurse -Force

        # 2. HIER IST DER FIX FÃœR "Python.h not found":
        # Wir kopieren den 'include' Ordner (da ist Python.h drin)
        Write-Host "Kopiere Header (include)..."
        Copy-Item -Path "$DonorPath\include" -Destination "$Dest\include" -Recurse -Force
        
        # Wir kopieren den 'libs' Ordner (fÃ¼r den Linker)
        Write-Host "Kopiere Libraries (libs)..."
        Copy-Item -Path "$DonorPath\libs" -Destination "$Dest\libs" -Recurse -Force
        
        # PrÃ¼fung (Text bereinigt)
        if (Test-Path "Engine\include\Python.h") { Write-Host "[OK] Python.h erfolgreich implantiert!" -ForegroundColor Green }
        else { Write-Host "[FEHLER] Python.h fehlt immer noch!" -ForegroundColor Red; exit 1 }

    # 5. Config Patch
    - name: ðŸ”§ Config Patch
      working-directory: Engine
      shell: cmd
      run: |
        echo python310.zip> python310._pth
        echo .>> python310._pth
        echo Lib>> python310._pth
        echo DLLs>> python310._pth
        echo Lib\site-packages>> python310._pth
        echo import site>> python310._pth

    # 6. Pip Setup
    - name: ðŸ”§ Pip Setup
      working-directory: Engine
      shell: cmd
      run: |
        curl -L -o get-pip.py https://bootstrap.pypa.io/get-pip.py
        .\python.exe get-pip.py --no-warn-script-location
        del get-pip.py
        .\python.exe -m pip install --upgrade pip setuptools wheel

    # 7. Build Tools vorbereiten
    - name: ðŸ”¨ Build Tools
      working-directory: Engine
      shell: cmd
      run: |
        .\python.exe -m pip install "numpy<1.24" cython

    # 8. AbhÃ¤ngigkeiten vorinstallieren
    - name: ðŸ§± AbhÃ¤ngigkeiten
      working-directory: Engine
      shell: cmd
      run: |
        .\python.exe -m pip install scipy pandas librosa matplotlib pysbd tqdm coqpit trainer
        .\python.exe -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 --no-warn-script-location

    # 9. TTS INSTALLATION
    - name: ðŸ—£ï¸ Install TTS
      working-directory: Engine
      shell: cmd
      run: |
        echo Versuche TTS Installation...
        REM Jetzt haben wir Python.h, jetzt sollte er bauen kÃ¶nnen!
        .\python.exe -m pip install TTS==0.22.0 --no-build-isolation --no-warn-script-location

    # 10. Restliche Tools
    - name: ðŸ“¦ Tools Installieren
      working-directory: Engine
      shell: cmd
      run: |
        .\python.exe -m pip install "opencv-python-headless<4.10" "opencv-python<4.10"
        .\python.exe -m pip install easyocr keyboard pyautogui pillow soundfile --no-warn-script-location

    # 11. Tests
    - name: ðŸ” TEST
      working-directory: Engine
      shell: cmd
      run: |
        echo --- TEST KEYBOARD ---
        .\python.exe -c "import keyboard; print('Keyboard: OK')" || exit 1
        
        echo --- TEST TTS ---
        .\python.exe -c "import TTS; print('TTS: OK')" || exit 1

    # 12. Cleanup & Zip
    - name: ðŸ§¹ Zippen
      working-directory: Engine
      shell: cmd
      run: |
        .\python.exe -m pip cache purge
        
        REM Wir kÃ¶nnen den 'include' Ordner wieder lÃ¶schen, um Platz zu sparen
        rmdir /s /q include
        rmdir /s /q libs
        
        if exist "Lib\site-packages\torch\test" rmdir /s /q "Lib\site-packages\torch\test"
        
        cd ..
        7z a -tzip -v1900m LQAG_Engine_V11.zip Engine

    - name: ðŸš€ Release Upload
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Engine-V11-FinalTry
        name: "LQAG Engine V11 (Header Fix Clean)"
        body: |
          ### Engine V11
          Gezwungener Build mit implantierten Header-Dateien (ohne Emojis).
        draft: false
        prerelease: false
        files: LQAG_Engine_V11.zip.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
