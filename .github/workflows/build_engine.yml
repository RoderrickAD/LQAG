name: Build Engine (GitHub Server)

on:
  workflow_dispatch:

jobs:
  build-engine:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # 1. Wir nutzen das offizielle Python Nuget Paket (EnthÃ¤lt Tkinter & alles!)
    - name: ðŸ Download Python Nuget (Portable Full)
      shell: powershell
      run: |
        Write-Host "Lade Python 3.10.11 Nuget Paket..."
        $url = "https://www.nuget.org/api/v2/package/python/3.10.11"
        Invoke-WebRequest -Uri $url -OutFile python_pkg.zip
        
        Write-Host "Entpacke..."
        Expand-Archive -Path python_pkg.zip -DestinationPath TempPython
        
        # Wir bauen uns unseren sauberen Engine Ordner
        New-Item -ItemType Directory -Force -Path "Engine"
        
        # Wir kopieren nur das 'tools' Verzeichnis, das ist das eigentliche Python
        Copy-Item -Path "TempPython\tools\*" -Destination "Engine" -Recurse -Force
        
        # AufrÃ¤umen
        Remove-Item python_pkg.zip
        Remove-Item -Recurse -Force TempPython
        
        Write-Host "Engine Basis steht. PrÃ¼fe Tkinter..."
        if (Test-Path "Engine\Lib\tkinter") { Write-Host "âœ” Tkinter gefunden!" -ForegroundColor Green }
        else { Write-Host "âŒ Tkinter fehlt!" -ForegroundColor Red; exit 1 }

    # 2. Pip installieren
    - name: ðŸ”§ Pip installieren
      working-directory: Engine
      shell: cmd
      run: |
        curl -L -o get-pip.py https://bootstrap.pypa.io/get-pip.py
        .\python.exe get-pip.py --no-warn-script-location
        del get-pip.py

    # 3. WICHTIG: Build Tools vorbereiten (gegen den C++ Fehler)
    - name: ðŸ”¨ Build-Umgebung vorbereiten
      working-directory: Engine
      shell: cmd
      run: |
        REM Wir aktualisieren die Tools, damit TTS kompiliert werden kann
        .\python.exe -m pip install --upgrade pip setuptools wheel

    # 4. Die schweren Pakete installieren
    # Wir nutzen --prefer-binary, damit er nicht versucht, alles selbst zu kompilieren
    - name: ðŸ“¦ KI & Treiber installieren
      working-directory: Engine
      shell: cmd
      run: |
        echo --- INSTALLIERE PYTORCH ---
        .\python.exe -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 --no-warn-script-location

        echo --- INSTALLIERE REST ---
        .\python.exe -m pip install numpy==1.26.4 --no-warn-script-location
        
        REM Hier passiert die Magie: Wir hoffen auf Wheels, sonst baut er es (Server hat C++ Tools)
        .\python.exe -m pip install TTS easyocr pyaudio keyboard pyautogui opencv-python pillow soundfile --prefer-binary --no-warn-script-location

        echo --- BEREINIGEN ---
        .\python.exe -m pip cache purge
        rmdir /s /q "Lib\site-packages\torch\test"
        rmdir /s /q "Lib\site-packages\TTS\bin"

    # 5. Zippen und Uploaden
    - name: ðŸ¤ Engine Zippen
      run: |
        7z a -tzip -v1900m LQAG_Engine_Final.zip Engine

    - name: ðŸš€ Release erstellen
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Engine-Final-GithubBuilt
        name: "LQAG Engine (Complete & Portable)"
        body: |
          ### Endlich komplett!
          Diese Engine wurde vollautomatisch auf GitHub gebaut.
          
          **EnthÃ¤lt:**
          - Python 3.10 (Portable)
          - Tkinter (GUI)
          - PyTorch (GPU)
          - TTS (Voice) & OCR
          - Keyboard Hook
          
          **Anleitung:**
          1. Lade alle Parts (`.001`, `.002` etc).
          2. Rechtsklick auf `.001` -> Entpacken.
          3. Den Ordner `Engine` in deinen Projektordner schieben.
        draft: false
        prerelease: false
        files: LQAG_Engine_Final.zip.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
