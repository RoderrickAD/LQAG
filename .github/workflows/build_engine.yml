name: Build Engine (The Transplant Method)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-engine:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # 1. Setup System Python (Spender)
    - name: üêç Setup System Python (Spender)
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.11' 
        architecture: 'x64'

    # 2. Setup MSVC (Microsoft Visual C++ Compiler)
    # This is crucial for compiling TTS!
    - name: üõ†Ô∏è Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    # 3. Download Portable Python (Empf√§nger)
    - name: üêç Download Portable Python (Empf√§nger)
      shell: cmd
      run: |
        curl -L -o python.zip https://www.python.org/ftp/python/3.10.11/python-3.10.11-embed-amd64.zip
        mkdir Engine
        tar -xf python.zip -C Engine
        del python.zip

    # 4. DIE TRANSPLANTATION (Tkinter vom System ins Portable kopieren)
    - name: üè• Operation durchf√ºhren (Transplant)
      shell: powershell
      run: |
        $DonorPath = python -c "import sys; print(sys.prefix)"
        Write-Host "Spender gefunden bei: $DonorPath"
        
        $Dest = "$pwd\Engine"
        
        New-Item -ItemType Directory -Force -Path "$Dest\Lib"
        New-Item -ItemType Directory -Force -Path "$Dest\DLLs"

        Write-Host "Kopiere System-DLLs..."
        copy "$DonorPath\DLLs\_tkinter.pyd" "$Dest\DLLs\"
        copy "$DonorPath\DLLs\tcl86t.dll" "$Dest\"
        copy "$DonorPath\DLLs\tk86t.dll" "$Dest\"
        
        Write-Host "Kopiere Tkinter Code..."
        Copy-Item -Path "$DonorPath\Lib\tkinter" -Destination "$Dest\Lib\tkinter" -Recurse -Force
        
        Write-Host "Kopiere Tcl Grafiken..."
        Copy-Item -Path "$DonorPath\tcl" -Destination "$Dest\tcl" -Recurse -Force
        
        if (Test-Path "$Dest\Lib\tkinter") { Write-Host "[ERFOLG] Tkinter erfolgreich transplantiert!" -ForegroundColor Green }
        else { Write-Host "[FEHLER] Transplantation fehlgeschlagen." -ForegroundColor Red; exit 1 }

    # 5. Konfiguration reparieren (.pth Datei)
    - name: üîß Pfade freischalten
      working-directory: Engine
      shell: cmd
      run: |
        echo python310.zip> python310._pth
        echo .>> python310._pth
        echo Lib>> python310._pth
        echo DLLs>> python310._pth
        echo Lib\site-packages>> python310._pth
        echo import site>> python310._pth

    # 6. Pip holen
    - name: üîß Pip installieren
      working-directory: Engine
      shell: cmd
      run: |
        curl -L -o get-pip.py https://bootstrap.pypa.io/get-pip.py
        .\python.exe get-pip.py --no-warn-script-location
        del get-pip.py

    # 7. Build Tools Update
    - name: üî® Pip Upgrade & Build Tools
      working-directory: Engine
      shell: cmd
      run: |
        .\python.exe -m pip install --upgrade pip setuptools wheel

    # 8. Installation der KI
    - name: üì¶ KI & Treiber installieren
      working-directory: Engine
      shell: cmd
      run: |
        echo --- INSTALLIERE PYTORCH ---
        .\python.exe -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121 --no-warn-script-location

        echo --- INSTALLIERE REST ---
        .\python.exe -m pip install numpy==1.22.4 --no-warn-script-location
        
        REM Install dependencies first to help TTS build
        .\python.exe -m pip install cython scipy
        
        REM Install TTS with --no-build-isolation to use installed build tools
        .\python.exe -m pip install TTS easyocr pyaudio keyboard pyautogui opencv-python pillow soundfile --prefer-binary --no-warn-script-location

        echo --- BEREINIGEN ---
        .\python.exe -m pip cache purge
        if exist "Lib\site-packages\torch\test" rmdir /s /q "Lib\site-packages\torch\test"
        if exist "Lib\site-packages\TTS\bin" rmdir /s /q "Lib\site-packages\TTS\bin"

    # 9. Zippen und Uploaden
    - name: ü§ê Engine Zippen
      run: |
        7z a -tzip -v1900m LQAG_Engine_Final.zip Engine

    - name: üöÄ Release erstellen
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Engine-Transplant-v4
        name: "LQAG Engine (Transplant Build v4)"
        body: |
          ### Engine V4 (Transplant + MSVC)
          Diese Engine ist eine Fusion aus Portable Python und den offiziellen GitHub-System-Bibliotheken.
          MSVC wurde f√ºr den Build verwendet.
          
          **Status:**
          - Python 3.10 Embeddable: ‚úî
          - Tkinter (Transplantiert): ‚úî
          - PyTorch & KI: ‚úî
          
          **Anleitung:**
          Entpacken und nutzen.
        draft: false
        prerelease: false
        files: LQAG_Engine_Final.zip.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
